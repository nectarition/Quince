---
import siteConfig from '../config';
import eventLibs from '../libs/event';
import dateLibs from '../libs/date';
import BaseLayout from '../layouts/BaseLayout/BaseLayout.astro';
import EventList from '../components/EventList.astro';
import Alert from '../components/Alert.astro';
import EventTypeLabel from '../components/EventTypeLabel.astro';
import PickUpEventList from '../components/PickUpEventList.astro';
import Hero from '../components/Hero.astro';
import Section from '../components/Section.astro';
import CalendarCard from '../components/CalendarCard.astro';
import ButtonGroup from '../components/ButtonGroup.astro';
import ReleaseNotes from '../components/ReleaseNotes.astro';
import { Sprite } from 'astro-icon';

const now = new Date();
now.setUTCHours(now.getUTCHours() + 9);
const today = new Date(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate());

const fetchedEvents = await eventLibs.getEventsAsync();
const fetchedLinks = await eventLibs.getLinksAsync();

const heldEvents = fetchedEvents
  .filter((e) => {
    const span = dateLibs.getSpan(e.date, today.getTime()) / 86400000;
    return span < 0 && span >= -30;
  })
  .sort((a, b) => a.order - b.order)
  .sort((a, b) => b.date - a.date);

const futureEvents = fetchedEvents.filter((e) => e.date > today.getTime());

const pickupEvents = futureEvents
  .filter((e) => e.date > today.getTime())
  .filter((e) => e.isPickUp)
  .sort((a, b) => a.order - b.order)
  .sort((a, b) => a.date - b.date);
---

<BaseLayout>
  <Hero title="ãƒœã‚¤ãƒ™ã¾ã¨ã‚" description="éŸ³å£°åˆæˆç³»ã‚¤ãƒ™ãƒ³ãƒˆé–‹å‚¬æƒ…å ±ã¾ã¨ã‚ã‚µã‚¤ãƒˆ" />

  <Section>
    <h2>ãŠçŸ¥ã‚‰ã›</h2>
    <Alert type="info" title="è¿½åŠ é€šçŸ¥ã¯ã˜ã‚ã¾ã—ãŸ">
      <ul>
        <li>ã‚¤ãƒ™ãƒ³ãƒˆã®è¿½åŠ é€šçŸ¥ã‚’å„ç¨®ã‚µãƒ¼ãƒ“ã‚¹ã«ã¦è¡Œã£ã¦ã„ã¾ã™ã€‚</li>
        <li>Discord: <a href="https://discord.gg/ggFnwgsUd3">å‚åŠ ã¯ã“ã¡ã‚‰</a></li>
        <li>ã¼ã™ããƒ¼: <a href="https://voskey.icalo.net/@vo">@vo@voskey.icalo.net</a></li>
      </ul>
    </Alert>

    <Alert type="info" title="ã”å¯„ä»˜ã‚’ãŠå¾…ã¡ã—ã¦ãŠã‚Šã¾ã™">
      ã‚µã‚¤ãƒˆã®ç¶™ç¶šé‹å–¶ã®ãŸã‚çš†æ§˜ã‹ã‚‰ã®ã”å¯„ä»˜ã‚’å—ã‘ä»˜ã‘ã¦ãŠã‚Šã¾ã™ã€‚<br />
      è©³ã—ãã¯<a href="https://donate.stripe.com/bIY16HfCS8e5aFGdRr">ã“ã¡ã‚‰</a>ã‚’ã”è¦§ãã ã•ã„ã€‚
    </Alert>
  </Section>

  <Section id="future-events">
    <h2>ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒˆ</h2>

    <table class="responsive-table">
      <thead>
        <tr>
          <th>æ—¥ä»˜</th>
          <th>ç¨®é¡</th>
          <th>éƒ½é“åºœçœŒ</th>
          <th>ã‚¤ãƒ™ãƒ³ãƒˆ</th>
        </tr>
      </thead>
      <tbody>
        {
          futureEvents.map((e) => (
            <tr class="event-row">
              <td class="pc-only">{dateLibs.format(e.date, 'YYYY/M/D (ddd)')}</td>
              <td class="pc-only">
                <EventTypeLabel eventType={e.type} isShort={true} />
              </td>
              <td class="pc-only">{eventLibs.getPrefecture(e.venue.address, true)}</td>
              <td class="sp-only">
                <div class="sp-event-header">
                  <span class="header-item">
                    <EventTypeLabel eventType={e.type} isShort={true} />
                  </span>
                  <span class="header-item">
                    <Sprite name="mdi:calendar" class="icon" />
                    {dateLibs.format(e.date, 'YYYY/M/D (ddd)')}
                  </span>
                  <span class="header-item">
                    <Sprite name="mdi:map-marker-outline" class="icon" />
                    {eventLibs.getPrefecture(e.venue.address, true)}
                  </span>
                </div>
              </td>
              <td class="event-name">
                {e.genre && (
                  <>
                    <small>{eventLibs.convertGenre(e.genre)}</small>
                    <br />
                  </>
                )}
                <a href={`#${e.id}`}>ã€Œ{e.name}ã€</a>
              </td>
            </tr>
          ))
        }
      </tbody>
    </table>
  </Section>

  <Section>
    <h2>
      ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆ <span class="label">PR</span>
    </h2>
    {
      pickupEvents.length > 0 ? (
        <>
          <PickUpEventList events={pickupEvents} today={today} links={fetchedLinks} />
          <p>
            <a href="/pick-up/#pick-up-event">ã€Œãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆã€ã¨ã¯ï¼Ÿ</a>
          </p>
        </>
      ) : (
        <p>
          ç¾åœ¨ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
          <br />
          <a href="/pick-up/#pick-up-event">ã€Œãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆã€ã¨ã¯ï¼Ÿ</a>
        </p>
      )
    }
  </Section>

  <Section id="event-info">
    <h2>ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±</h2>
    <EventList sectionHeadingId="event-info" events={futureEvents} today={today} links={fetchedLinks} />
  </Section>

  <Section id="held-events">
    <h2>æœ€è¿‘çµ‚äº†ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆ</h2>
    {heldEvents.length > 0 ? <EventList sectionHeadingId="held-events" events={heldEvents} today={today} links={fetchedLinks} /> : <p>æœ€è¿‘çµ‚äº†ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</p>}
    <ButtonGroup align="center">
      <a href="/archives/" class="btn">éå»ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¡¨ç¤º</a>
    </ButtonGroup>
  </Section>

  <Section>
    <h2>ã‚ãªãŸã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ã‚‚è¿½åŠ ã§ãã¾ã™ï¼</h2>

    <p>Google ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãªã©ã¸ã®è¿½åŠ ã«ã¯ä»¥ä¸‹ã®URLã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚</p>

    <div class="calendar-grid">
      <CalendarCard title="ã‚¤ãƒ™ãƒ³ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼" url={`${siteConfig.siteURL}/event-schedule.ics`} webcalUrl="webcal://vo.nrsy.jp/event-schedule.ics" buttonText="ç«¯æœ«ã«è¿½åŠ  (ã‚¤ãƒ™ãƒ³ãƒˆ)" />

      <CalendarCard title="ç· ã‚åˆ‡ã‚Šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼" url={`${siteConfig.siteURL}/limits.ics`} webcalUrl="webcal://vo.nrsy.jp/limits.ics" buttonText="ç«¯æœ«ã«è¿½åŠ  (ç· ã‚åˆ‡ã‚Š)" />
    </div>

    <Alert type="info" title="Google ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¸ã®è¿½åŠ æ–¹æ³• (PC)">
      <ol>
        <li>Google ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’é–‹ãã¾ã™</li>
        <li>å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã€Œä»–ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã€æ¨ªã«ã‚ã‚‹ã€Œï¼‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™</li>
        <li>ã€ŒURL ã§è¿½åŠ ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™</li>
        <li>ã€Œã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã® URLã€ã«ä¸Šè¿°ã®URLã‚’å…¥åŠ›ã—ã¾ã™</li>
        <li>ã€Œã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’è¿½åŠ ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨åŒæœŸãŒå§‹ã¾ã‚Šã¾ã™</li>
      </ol>
    </Alert>

    <Alert type="info" title="ã‚¹ãƒãƒ›ã§ã®è¿½åŠ æ–¹æ³• (iOS/Android)"> ä¸Šã®ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨è¨±å¯ã‚’æ±‚ã‚ã‚‹ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã€Œè¨±å¯ã€ã‚’æŠ¼ã™ã¨è¿½åŠ ã§ãã¾ã™ã€‚ </Alert>
  </Section>

  <Section>
    <h2>ã‚¤ãƒ™ãƒ³ãƒˆã®æ²è¼‰åŸºæº–ã«ã¤ã„ã¦</h2>
    <ul>
      <li>æ—¥ç¨‹åŠã³ä¼šå ´ãŒ Web ä¸Šã§å…¬é–‹ã•ã‚Œã¦ã„ã‚‹åŒäººèªŒå³å£²ä¼šãªã©ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ²è¼‰ã—ã¦ã„ã¾ã™ã€‚</li>
      <li>åŒäººèªŒå³å£²ä¼šä»¥å¤–ã®ã‚¤ãƒ™ãƒ³ãƒˆã¯ã€å³å£²ä¼šã¨åŒæ—¥ãƒ»å‰ç¿Œæ—¥ã«é–‹å‚¬ã•ã‚Œã‚‹ã‚‚ã®ã®ã¿æ²è¼‰ã—ã¦ã„ã¾ã™ã€‚</li>
      <li>Webã‚ªãƒ³ãƒªãƒ¼ãªã©ã®ã‚ªãƒ•ãƒ©ã‚¤ãƒ³é–‹å‚¬ã§ã¯ãªã„ã‚¤ãƒ™ãƒ³ãƒˆã¯æ²è¼‰ã—ã¦ã„ã¾ã›ã‚“ã€‚</li>
    </ul>
    <ButtonGroup align="center">
      <a href="https://admin.vo.nrsy.jp/" class="btn btn-primary" target="_blank">ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã‚’æä¾›ã™ã‚‹</a>
    </ButtonGroup>
  </Section>

  <Section>
    <h2>ã“ã®ã‚µã‚¤ãƒˆã«ã¤ã„ã¦</h2>
    <ul>
      <li>ã“ã® Web ã‚µã‚¤ãƒˆã¯ãƒ•ã‚¡ãƒ³å€‹äººãŒé‹å–¶ã—ã¦ãŠã‚Šã¾ã™ã€‚ã‚¤ãƒ™ãƒ³ãƒˆé‹å–¶æ§˜ã‚„é–¢é€£ä¼æ¥­æ§˜ã¨ã¯ä¸€åˆ‡é–¢ä¿‚ã”ã–ã„ã¾ã›ã‚“ã€‚</li>
      <li>X (Twitter)ã€ã‚¤ãƒ™ãƒ³ãƒˆ Web ã‚µã‚¤ãƒˆãªã©ã€Web ä¸Šã‹ã‚‰ä¸€æ¬¡æƒ…å ±ã‚’å‚ç…§ã§ãã‚‹æƒ…å ±ã‚’ã‚‚ã¨ã«ä½œæˆã—ã¦ã„ã¾ã™ã€‚</li>
      <li>å†…å®¹ã¯æ­£ç¢ºã§ãªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚å„ã‚¤ãƒ™ãƒ³ãƒˆã® Web ã‚µã‚¤ãƒˆã‚’å¿…ãšã”ç¢ºèªãã ã•ã„ã€‚</li>
    </ul>
  </Section>

  <Section>
    <h2>å¿œæ´ã‚’ãŠé¡˜ã„ã—ã¾ã™ğŸ™‡</h2>
    <ul>
      <li>å½“ã‚µã‚¤ãƒˆã¯å€‹äººé‹å–¶ã®ãŸã‚ã€ã‚µãƒ¼ãƒãƒ¼ç¶­æŒè²»ã‚„ãƒ‰ãƒ¡ã‚¤ãƒ³è²»ç”¨ãªã©ã®é‹å–¶ã‚³ã‚¹ãƒˆã‚’å¯„ä»˜ã§è³„ã£ã¦ãŠã‚Šã¾ã™ã€‚</li>
      <li>çš†æ§˜ã‹ã‚‰ã®ã”æ”¯æ´ãŒã‚µã‚¤ãƒˆã®ç¶™ç¶šã¨æ”¹å–„ã«ç¹‹ãŒã‚Šã¾ã™ã€‚ä½•å’ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚</li>
      <li>ã‚¤ãƒ™ãƒ³ãƒˆä¸»å‚¬è€…æ§˜ã§ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆæ²è¼‰ã‚’ã”å¸Œæœ›ã®æ–¹ã‚‚ã€å¯„ä»˜ã«ã‚ˆã‚‹æ²è¼‰ãŒå¯èƒ½ã§ã™ã€‚</li>
      <li>è©³ã—ãã¯<a href="/pick-up/#pick-up-event">ã“ã¡ã‚‰</a>ã‚’ã”è¦§ãã ã•ã„ã€‚</li>
    </ul>
    <ButtonGroup align="center">
      <a href="https://donate.stripe.com/bIY16HfCS8e5aFGdRr" class="btn btn-primary">å¯„ä»˜ã™ã‚‹</a>
      <a href="/pick-up/" class="btn">ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—æ²è¼‰ã«ã¤ã„ã¦</a>
    </ButtonGroup>
  </Section>

  <Section>
    <h2>API ã«ã¤ã„ã¦</h2>
    <ul>
      <li>å½“ã‚µã‚¤ãƒˆã§ã¯ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã‚’å–å¾—ã™ã‚‹ãŸã‚ã® API ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚</li>
      <li>API ã®è©³ç´°ã«ã¤ã„ã¦ã¯<a href="/api/docs/">ã“ã¡ã‚‰</a>ã‚’ã”è¦§ãã ã•ã„ã€‚</li>
    </ul>
    <ButtonGroup align="center">
      <a href="/api/docs/2025-02-04/" class="btn btn-primary">API ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è¦‹ã‚‹</a>
    </ButtonGroup>
  </Section>

  <Section>
    <h2>ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆ</h2>
    <ReleaseNotes />
  </Section>

  <p class="banner-link">
    <a href="https://vo.nrsy.jp" target="_blank"><img src="https://vo.nrsy.jp/banner.png" alt="éŸ³å£°åˆæˆç³»ã‚¤ãƒ™ãƒ³ãƒˆé–‹å‚¬æƒ…å ±ã¾ã¨ã‚ã‚µã‚¤ãƒˆ" style="width: 200px; height: 40px" /></a>
    <a href="https://seidouren.jp" target="_blank"><img src="https://seidouren.jp/banner.png" alt="å£°åŒé€£: éŸ³å£°åˆæˆç³»åŒäººèªŒå³å£²ä¼šé€£çµ¡ä¼š" style="width: 200px; height: 40px" /></a>
  </p>
</BaseLayout>

<style lang="scss">
  .label {
    display: inline-block;
    border: 1px solid var(--primary-brand-color);
    color: var(--primary-brand-color);
    padding: 2px 8px;
    font-size: 0.75em;
    font-weight: normal;
    border-radius: 5px;
    margin-left: 8px;
  }

  .responsive-table {
    border-collapse: collapse;

    thead {
      @media screen and (max-width: 840px) {
        display: none;
      }

      tr {
        border-bottom: 2px solid var(--border-color);
      }

      th {
        padding: 10px;
        text-align: left;
        font-weight: 600;
        color: #555;
        font-size: 0.9em;

        @media screen and (max-width: 840px) {
          padding: 8px 10px;
          font-size: 0.85em;
        }
      }
    }

    tbody {
      tr {
        border-bottom: 1px solid #f0f0f0;
        &:last-child {
          border-bottom: none;
        }

        &.event-row {
          @media screen and (max-width: 840px) {
            display: block;
            padding: 10px;
          }
        }
      }
    }

    td {
      padding: 10px;
      vertical-align: middle;

      &.event-name {
        white-space: normal;
      }

      @media screen and (max-width: 840px) {
        padding: 0;
      }

      &.pc-only {
        @media screen and (max-width: 840px) {
          display: none;
        }
      }

      &.sp-only {
        @media screen and (min-width: 841px) {
          display: none;
        }

        @media screen and (max-width: 840px) {
          display: flex;
          flex-flow: column;
          .sp-event-header {
            display: flex;
            gap: 10px;
            .header-item {
              flex: 1;
            }
          }
          .event-row {
            grid-template-columns: 30% 30% auto;
            column-gap: 10px;
            row-gap: 2px;
          }
          .event-name {
            grid-column: 1 / 4;
          }
          .event-date {
            grid-row: 1;
            grid-column: 2;
          }
          .event-type {
            grid-row: 1;
            grid-column: 1;
          }
          .event-area {
            grid-row: 1;
            grid-column: 3;
          }
        }
      }

      small {
        color: #888;
        font-size: 0.85em;
      }
    }
  }

  .icon {
    vertical-align: middle;
    width: 1.5em;
    height: 1.5em;
    color: #606060;
  }

  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 16px;
    margin: 20px 0;

    @media screen and (max-width: 840px) {
      grid-template-columns: 1fr;
      gap: 12px;
      margin: 16px 0;
    }
  }

  .banner-link {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 24px;
    margin-top: 24px;

    img {
      transition:
        transform 0.2s,
        box-shadow 0.2s;
      border-radius: 5px;

      &:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
    }
  }
</style>
