---
import eventLib from '../libs/event';
import dateLib from '../libs/date';
import type { PearEventAppModel, PearEventLink } from '@types';
import EventTypeLabel from './EventTypeLabel.astro';

export interface Props {
  today: Date;
  event: PearEventAppModel;
  links: PearEventLink[];
  isPickUp?: boolean;
}

const { event, today, links, isPickUp } = Astro.props;

const span = Math.floor(dateLib.getSpan(event.date, today.getTime()) / 86400000);
const eventType = eventLib.convertEventType(event.type);
const sortedLinks = links.sort((a, b) => (a.order ?? Number.MIN_SAFE_INTEGER) - (b.order ?? Number.MAX_SAFE_INTEGER)) ;
---

<div class="cardWrap" id={event.id}>
  <article class="card" style={`--event-color: ${eventType.color};`}>
    <div class={`card_dateArea_wrap ${(span >= 0 && span <= 14 && 'card_dateArea_wrap-near') ?? ''}`}>
      <div class="card_dateArea_container">
        <div class="card_dateArea_year">{dateLib.format(event.date, 'YYYY.')}</div>
        <div class="card_dateArea_date">{dateLib.format(event.date, 'M.D')}</div>
        <div class="card_dateArea_day">{dateLib.format(event.date, '(ddd)')}</div>
      </div>
      <div class="card_countArea">
      {span === 0
        ? <span class="badge badge-nearly">本日開催</span>
        : span > 0
          ? <span class={`badge badge-${span <= 14 ? 'nearly' : 'upcoming'}`}>
              <span class="badge-label">あと</span>
              <span class="badge-number">&nbsp;{span}&nbsp;</span>
              <span class="badge-label">日</span>
            </span>
          : span >= -10
            ? <span class="badge badge-ended">{Math.abs(span)} 日前に終了</span>
            : <></>}
      </div>
    </div>
    
    <div class="card_content">
      <div class="card_header">
        <div class="card_labelArea">
          <EventTypeLabel eventType={event.type} />
        </div>
        <div class="card_eventArea">
          <div class="card_eventArea_genre">{eventLib.convertGenre(event.genre)}</div>
          <h3 class="card_eventArea_name">
            <a href={event.websiteURL} target="_blank">
              {event.name}
            </a>
          </h3>
          {event.pickUpMessage && isPickUp && (
            <div class="pickUpMessage">
              <div class="pickUpMessage_content">{event.pickUpMessage}</div>
            </div>
          )}
          {event.subEvents.length > 0 && (
            <div class="card_eventArea_subEvents">
              {event.subEvents.map((subEvent) => (
                <div class="subEvent-item">
                  <span class="subEvent-genre">{subEvent.genre}</span>
                  <span class="subEvent-name">
                    {(
                      subEvent.url
                        ? <a href={subEvent.url} target="_blank">{subEvent.name}</a> 
                        : subEvent.name
                    )}
                  </span>
                </div>
              ))}
            </div>
          )}
        </div>
        
        {sortedLinks.length > 0 && (
          <div class="card_linkArea">
            <ul class="link-list">
              {sortedLinks
                .map((l) => {
                const limitSpan = l.limit !== null
                  ? Math.floor(dateLib.getSpan(l.limit, today.getTime()) / 86400000)
                  : null;
                return (
                  <li class="link-item">
                    <a href={l.url} target="_blank" class={!l.limit || (limitSpan ?? -1) >= 0 ? '' : 'link-expired'}>
                      {!l.limit || (limitSpan ?? -1) >= 0 ? l.name : `${l.name} (締切済)`}
                    </a>
                    {l.limit && limitSpan !== null && limitSpan >= 0 && (
                      <span class="deadline">
                        <span class="deadline-date">{dateLib.format(l.limit, 'YYYY/M/D')}</span>
                        <span class="deadline-remaining">あと{limitSpan}日</span>
                      </span>
                    )}
                  </li>
                );
              })}
            </ul>
          </div>
        )}
      </div>

      <div class="card_body">
        <div class="card_placeArea">
          <div class="card_placeArea_place">
            <span class="tag tag-location">{eventLib.getPrefecture(event.venue.address)}</span>
            <span class="venue-name">{event.venue.name}{event.roomName && ` ${event.roomName}`}</span>
          </div>
          <div class="card_placeArea_placeDetail">
            <a href={`https://www.google.co.jp/maps/search/${encodeURIComponent(event.venue.address)}`} target="_blank">
              〒{eventLib.convertPostalCode(event.venue.postalCode)} {event.venue.address}
            </a>
          </div>
        </div>

        <div class="card_remarksArea">
          <div class="card_remarksArea_item">
            <span class="card_remarksArea_label">備考:</span> {event.remarks}
          </div>
          <div class="card_remarksArea_item">
            <span class="card_remarksArea_label">運営:</span> {event.organizer.name}
          </div>
        </div>
      </div>
    </div>
  </article>
</div>

<style lang="scss">
  .cardWrap {
    scroll-margin-top: 20px;
  }

  .card {
    background: white;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    border: 1px solid var(--border-color);
    border-left: 3px solid var(--event-color);
    display: grid;
    grid-template-columns: 140px 1fr;

    @media screen and (max-width: 840px) {
      grid-template-columns: 1fr;
    }
  }

  .card_dateArea {
    &_wrap {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-flow: column;
      background: #fafafa;
      padding: 12px;
      border-right: 1px solid var(--border-color);

      &-near {
        background: #fff0f0;
      }

      @media screen and (max-width: 840px) {
        flex-flow: row;
        justify-content: flex-start;
        border-right: none;
        border-bottom: 1px solid var(--border-color);
        padding: 12px;
        gap: 10px;
      }
    }

    &_container {
      text-align: center;
    }

    &_year {
      font-size: 0.85em;
      color: #888;
    }

    &_date {
      font-size: 2em;
      font-weight: 600;
      color: var(--event-color, var(--primary-brand-color));
      line-height: 1.2;
      margin-bottom: 2px;
    }

    &_day {
      font-size: 0.9em;
      color: #666;
      margin-bottom: 8px;
    }

    &_count {
      margin-top: 8px;
    }

    @media screen and (max-width: 840px) {
      &_container {
        display: flex;
        align-items: center;
        gap: 3px;
        text-align: left;
      }

      &_year,
      &_date,
      &_day {
        display: inline;
        margin: 0;
      }

      &_year {
        font-size: 1.25em;
      }

      &_date {
        font-size: 1.5em;
      }

      &_count {
        margin: 0;
      }
    }
  }

  .badge {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 10px;
    font-size: 0.7em;
    font-weight: 500;
    white-space: nowrap;

    &-nearly {
      background: var(--danger-color);
      color: white;
    }

    &-upcoming {
      background: var(--success-color);
      color: white;
    }

    &-ended {
      background: #999;
      color: white;
    }

    &-label {
      font-size: 0.9em;
    }

    &-number {
      font-size: 1.3em;
      font-weight: 700;
      margin: 0 2px;
    }
  }

  @keyframes pulse {
    0%, 100% {
      opacity: 1;
    }
    50% {
      opacity: 0.8;
    }
  }

  .card_content {
    padding: 16px 20px;
    display: flex;
    flex-direction: column;
    gap: 14px;

    @media screen and (max-width: 840px) {
      padding: 14px;
      gap: 12px;
    }
  }

  .card_header {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .card_labelArea {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .card_eventArea {
    &_genre {
      font-size: 0.85em;
      color: #666;
      margin-bottom: 6px;
      font-weight: 500;
    }

    &_name {
      font-size: 1.25em;
      font-weight: 600;
      line-height: 1.4;
      color: #333;
      border-left: none;
      padding-left: 0;

      @media screen and (max-width: 840px) {
        font-size: 1.2em;
      }
    }

    &_subEvents {
      margin-top: 8px;
      padding-left: 12px;

      .subEvent-item {
        display: flex;
        align-items: baseline;
        gap: 6px;
        font-size: 0.85em;
        margin-bottom: 4px;
        line-height: 1.5;

        &:last-child {
          margin-bottom: 0;
        }

        &::before {
          content: '└';
          color: #999;
          margin-right: 2px;
        }
      }

      .subEvent-genre {
        color: #666;
        font-size: 0.9em;
        white-space: nowrap;
        
        &::after {
          content: ':';
          margin-left: 1px;
        }
      }

      .subEvent-name {
        color: #555;
      }
    }
  }

  .card_body {
    display: flex;
    flex-direction: column;
    gap: 14px;
    padding-top: 14px;
    border-top: 1px solid var(--border-color);

    @media screen and (max-width: 840px) {
      gap: 12px;
      padding-top: 12px;
    }
  }

  .card_section_title {
    font-size: 0.85em;
    font-weight: 600;
    color: #666;
    margin-bottom: 8px;
  }

  .card_placeArea {
    &_place {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      flex-wrap: wrap;

      .venue-name {
        font-weight: 600;
        color: #333;
      }
    }

    &_placeDetail {
      font-size: 0.85em;
      color: #666;
      line-height: 1.6;
    }
  }

  .card_linkArea {
    .link-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .link-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin: 0;
      padding: 8px 10px;
      background: #f0f5ff;
      border-radius: 5px;
      border-left: 3px solid #d0e0ff;

      a {
        font-weight: 500;
        flex: 1;
        display: flex;
        align-items: center;
        gap: 6px;

        &.link-expired {
          text-decoration: line-through;
          opacity: 0.6;
          &:hover {
            text-decoration: line-through underline;
          }
        }
      }

      .deadline {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.8em;
        white-space: nowrap;
        color: #666;

        &-date {
          font-weight: 500;
          color: #555;
        }

        &-remaining {
          padding: 2px 6px;
          background: #e8e8e8;
          color: #666;
          border-radius: 10px;
          font-size: 0.9em;
          font-weight: 500;
        }
      }

      @media screen and (max-width: 840px) {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
    }
  }

  .card_remarksArea {
    display: flex;
    flex-direction: column;
    gap: 4px;
    font-size: 0.8em;
    color: #888;
    padding-top: 10px;
    border-top: 1px solid var(--border-color);

    &_item {
      line-height: 1.5;
    }

    &_label {
      font-weight: 600;
      color: #666;
      margin-right: 4px;
    }
  }

  .tag {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 5px;
    font-size: 0.8em;
    font-weight: 500;
    white-space: nowrap;
    background: #f0f0f0;
    color: #666;

    &-secondary {
      background: white;
      border: 1px solid #e0e0e0;
      color: #666;
    }

    &-location {
      background: var(--event-color);
      color: white;
    }
  }

  .pickUpMessage {
    margin: 10px 0 0 0;
    padding: 10px 14px;
    background: linear-gradient(135deg, #fff8e1 0%, #fff3cd 100%);
    border: 1px solid #ffecb3;
    border-left: 3px solid #ffa000;
    border-radius: 5px;
    display: flex;
    align-items: flex-start;
    gap: 8px;
    font-size: 0.9em;

    @media screen and (max-width: 840px) {
      padding: 8px 12px;
      font-size: 0.85em;
    }

    &_icon {
      font-size: 1.2em;
      flex-shrink: 0;
      line-height: 1;
    }

    &_content {
      white-space: pre-wrap;
      line-height: 1.6;
      color: #5d4037;
      flex: 1;
    }
  }
</style>
